name: Deploy to Fly.io

on:
  push:
    branches:
      - main
    paths:
      - 'app/**'
      - 'requirements.txt'
      - 'Dockerfile'
      - 'fly.toml'
      - '.github/workflows/fly-deploy.yml'
  workflow_dispatch:  # Allow manual triggers

concurrency:
  group: fly-deploy
  cancel-in-progress: false  # Don't cancel deployments in progress

jobs:
  deploy:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        run: flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Verify Deployment
        run: |
          echo "âœ… Deployment complete!"
          echo "ğŸŒ Live URL: https://license-server-demo.fly.dev"
          echo "ğŸ“Š Metrics Dashboard: https://license-server-demo.fly.dev/metrics-dashboard"
          echo "ğŸ¯ Presentation: https://license-server-demo.fly.dev/presentation"
          
          # Wait a few seconds for the app to start
          sleep 5
          
          # Basic health check
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://license-server-demo.fly.dev/licenses/status || echo "000")
          
          if [ "$STATUS_CODE" = "200" ]; then
            echo "âœ… Health check passed (HTTP $STATUS_CODE)"
          else
            echo "âš ï¸  Health check returned HTTP $STATUS_CODE"
            exit 1
          fi

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              ## ğŸš€ Deployed to Fly.io
              
              **Live URLs:**
              - ğŸ  Dashboard: https://license-server-demo.fly.dev
              - ğŸ“Š Metrics: https://license-server-demo.fly.dev/metrics-dashboard
              - ğŸ¯ Presentation: https://license-server-demo.fly.dev/presentation
              - ğŸ“– API Docs: https://license-server-demo.fly.dev/docs
              
              **Test it:**
              \`\`\`bash
              curl https://license-server-demo.fly.dev/licenses/status | jq
              \`\`\`
              `
            })
